# HoVer-NeXt Inference
HoVer-NeXt is a fast and efficient nuclei segmentation and classification pipeline. 

Supported are a variety of data formats, including all OpenSlide supported datatypes, `.npy` numpy array dumps, and common image formats such as JPEG and PNG.
If you are having trouble with using this repository, please create an issue and we will be happy to help!

For training code, please check the [hover-next training repository](https://github.com/digitalpathologybern/hover_next_train)

Find the Publication here: [https://openreview.net/pdf?id=3vmB43oqIO](https://openreview.net/pdf?id=3vmB43oqIO)

This is an updated version of the Hover-NeXt code for the manuscript:
"AI-detected tumor-infiltrating lymphocytes for predicting outcomes in anti-PD1 based treated melanoma."

The weights from this model are created on an updated version of the Panoptic Segmentation of nUclei and tissue in advanced MelanomA (PUMA) dataset. 
Find the publication of the PUMA dataset here: [PUMA dataset - GigaScience](https://doi.org/10.1093/gigascience/giaf011)
To use the weights, specify the checkpoint as "puma_convnextv2_base".

## Setup

```bash
conda env create -f environment.yml
conda activate hovernext
pip install torch==2.1.1 torchvision==0.16.1 --index-url https://download.pytorch.org/whl/cu118
```

## Model Weights

Weights are hosted on [Zenodo](https://zenodo.org/records/10635618)
By specifying one of the ID's listed, weights are **automatically** downloaded and loaded. 

| Dataset      | ID | Weights |
|--------------|--------|-----|
| Lizard-Mitosis |   "lizard_convnextv2_large"   | [Large](https://zenodo.org/records/10635618/files/lizard_convnextv2_large.zip?download=1) |
|  | "lizard_convnextv2_base" |[Base](https://zenodo.org/records/10635618/files/lizard_convnextv2_base.zip?download=1)      |
|  | "lizard_convnextv2_tiny" |[Tiny](https://zenodo.org/records/10635618/files/lizard_convnextv2_tiny.zip?download=1)      |
| PanNuke | "pannuke_convnextv2_tiny_1"  | [Tiny Fold 1](https://zenodo.org/records/10635618/files/pannuke_convnextv2_tiny_1.zip?download=1) |
|   | "pannuke_convnextv2_tiny_2"  | [Tiny Fold 2](https://zenodo.org/records/10635618/files/pannuke_convnextv2_tiny_2.zip?download=1) |
|   | "pannuke_convnextv2_tiny_3"  | [Tiny Fold 3](https://zenodo.org/records/10635618/files/pannuke_convnextv2_tiny_3.zip?download=1) |
|  Melanoma | "puma_convnextv2_base"     | [Base](https://zenodo.org/records/15526308) |

If you are manually downloading weights, unzip them in the directory, such that the folder (e.g. ```lizard_convnextv2_large```) sits in the same directory as ```main.py```.

## WSI Inference

This pipeline uses OpenSlide to read images, and therefore supports all formats which are supported by OpenSlide. 
If you want to run this pipeline on custom ome.tif files, ensure that the necessary metadata such as resolution, downsampling and dimensions are available. 
Additionally, czi is is supported via pylibCZIrw.
Before running a slide, choose [appropriate parameters for your machine](#optimizing-inference-for-your-machine)

To run a single slide:

```bash
python3 main.py \
    --input "/path-to-wsi/wsi.svs" \
    --output_root "results/" \
    --cp "puma_convnextv2_base" \
    --tta 4 \
    --inf_workers 16 \
    --pp_tiling 10 \
    --pp_workers 16
```

To run multiple slides, specify a glob pattern such as `"/path-to-folder/*.mrxs"` or provide a list of paths as a `.txt` file.

### Slurm

if you are running on a slurm cluster you might consider separating pre and post-processing to improve GPU utilization.
Use the `--only_inference` parameter and submit another job on with the same parameters, but removing the `--only_inference`.

## NPY / Image inference

NPY and image inference works the same as WSI inference, however output files are only a ZARR array.

```bash
python3 main.py \
    --input "/path-to-file/file.npy" \
    --output_root "/results/" \
    --cp "lizard_convnextv2_large" \
    --tta 4 \
    --inf_workers 16 \
    --pp_tiling 10 \
    --pp_workers 16
```

Support for other datatypes are easy to implement. Check the NPYDataloader for reference.

## Optimizing inference for your machine:

1. WSI is on the machine or on a fast access network location
2. If you have multiple machines, e.g. CPU-only machines, you can move post-processing to that machine
3. '--tta 4' yields robust results with very high speed
4. '--inf_workers' should be set to the number of available cores
5. '--pp_workers' should be set to number of available cores -1, with '--pp_tiling' set to a low number where the machine does not run OOM. E.g. on a 16-Core machine, '--pp_workers 16 --pp_tiling 8 is good. If you are running out of memory, increase --pp_tiling.

# Downstream Analysis Pipeline Usage

This document provides instructions for using the output files generated by the nuclei/tissue GeoJSON pipeline for downstream analysis, specifically in the context of the manuscript:  
**"AI-detected tumor-infiltrating lymphocytes for predicting outcomes in anti-PD1 based treated melanoma."**

## Overview

After running the main pipeline, you will have:
- Instance-maps
- Class-lookup tables with centroids
- `.tsv` files for QuPath visualization

For further downstream processing the following scripts are available

## 1. Convert TSV to QuPath-Compatible GeoJSON

**Script:** `scripts_melanoma_analysis/01_tsv_to_geojson.py`  
**Purpose:**  
Convert the pipeline-generated TSV files to GeoJSON files with bounding box annotations, compatible with QuPath for fast visualization.

**Usage:**
```bash
python scripts_melanoma_analysis/01_tsv_to_geojson.py --input_dir "directory_containing_output_folders_from_main.py"

``` 
Replace "directory_containing_output_folders_from_main" with the path to your pipeline output folder (where the TSVs are stored).

2. Filter Nuclei in Tumor Area
Script: scripts_melanoma_analysis/02_filter_nuclei_tumor_area.py
Purpose:
Filter nuclei GeoJSONs using tissue annotation files to keep only nuclei within annotated tumor areas (and, for instance, exclude necrosis). Outputs filtered `.geoJSON` and `.csv` files for further analysis.

Usage:
```bash
python scripts_melanoma_analysis/02_filter_nuclei_tumor_area.py \
    --nuclei_geojson_folder "path_to_nuclei_geojsons" \
    --tissue_geojson_folder "path_to_tissue_geojsons" \
    --results_path "output_results_folder" \
    --geojson_output_path "filtered_geojson_output_folder"
```
Replace each path with your respective folders from previous pipeline steps.


# License

This repository is licensed under GNU General Public License v3.0 (See License Info).
If you are intending to use this repository for commercial usecases, please check the licenses of all python packages referenced in the Setup section / described in the requirements.txt and environment.yml.

# Citation

If you are using this code, please cite:
```
@inproceedings{baumann2024hover,
  title={HoVer-NeXt: A Fast Nuclei Segmentation and Classification Pipeline for Next Generation Histopathology},
  author={Baumann, Elias and Dislich, Bastian and Rumberger, Josef Lorenz and Nagtegaal, Iris D and Martinez, Maria Rodriguez and Zlobec, Inti},
  booktitle={Medical Imaging with Deep Learning},
  year={2024}
}
```
and
```
@INPROCEEDINGS{rumberger2022panoptic,
  author={Rumberger, Josef Lorenz and Baumann, Elias and Hirsch, Peter and Janowczyk, Andrew and Zlobec, Inti and Kainmueller, Dagmar},
  booktitle={2022 IEEE International Symposium on Biomedical Imaging Challenges (ISBIC)}, 
  title={Panoptic segmentation with highly imbalanced semantic labels}, 
  year={2022},
  pages={1-4},
  doi={10.1109/ISBIC56247.2022.9854551}}
```

and

```
@article{schuiveling2025novel,
author={Mark Schuiveling and Hong Liu and Daniel Eek and Gerben E Breimer and Karijn P M Suijkerbuijk and Willeke A M Blokx and Mitko Veta},
title={A novel dataset for nuclei and tissue segmentation in melanoma with baseline nuclei segmentation and tissue segmentation benchmarks},
journal={GigaScience},
volume={14},
year={2025},
article={giaf011},
doi={10.1093/gigascience/giaf011}
}
```